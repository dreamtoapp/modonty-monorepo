// This is your Prisma schema file for Modonty Blog Platform
// MongoDB provider for multi-client blog platform with 100% SEO optimization

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // NextAuth.js required fields
  name          String?
  email         String?   @unique
  emailVerified DateTime? // Email verification timestamp
  image         String? // NextAuth standard field (profile image URL)

  // Custom fields
  password String? // Hashed password (optional for OAuth users)
  role     UserRole @default(EDITOR)
  avatar   String? // Keep for compatibility, prefer using 'image'

  // Links to clients (for client users)
  clientAccess String[] @db.ObjectId // Array of client IDs this user can access

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NextAuth.js relations
  accounts Account[]
  sessions Session[]

  @@index([role])
  @@map("users")
}

enum UserRole {
  ADMIN
  CLIENT
  EDITOR
}

// ============================================
// NEXTAUTH.JS MODELS (OAuth & Email Auth)
// ============================================

model Account {
  id                String @id @default(auto()) @map("_id") @db.ObjectId
  userId            String @db.ObjectId
  type              String // OAuth or email
  provider          String // google, facebook, credentials, etc.
  providerAccountId String // Provider's unique user ID

  // OAuth tokens (optional, for OAuth providers)
  refresh_token String?
  access_token  String?
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String?
  session_state String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String // Email address or other identifier
  token      String   @unique
  expires    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CLIENT (ORGANIZATION SCHEMA)
// ============================================

model Client {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String  @unique
  legalName String? // Schema.org Organization
  url       String? // Organization website

  // Branding
  logo         String?
  favicon      String?
  ogImage      String? // Default OG image for all articles
  primaryColor String?

  // Schema.org Organization - Social profiles
  sameAs String[] // LinkedIn, Twitter, Facebook URLs

  // Contact
  email String?
  phone String?

  // SEO
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[]

  // Metadata
  foundingDate DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relationships
  articles    Article[]
  subscribers Subscriber[]

  @@map("clients")
}

// ============================================
// CATEGORY
// ============================================

model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String  @unique
  description String?
  parentId    String? @db.ObjectId // Hierarchical categories

  // SEO
  seoTitle       String?
  seoDescription String?
  seoKeywords    String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  articles Article[]
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("CategoryHierarchy")

  @@index([parentId])
  @@map("categories")
}

// ============================================
// TAG
// ============================================

model Tag {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())

  // Relationships
  articles ArticleTag[]

  @@map("tags")
}

// ============================================
// AUTHOR (PERSON SCHEMA - E-E-A-T)
// ============================================

model Author {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String // Schema.org Person
  slug String @unique

  // Schema.org Person - E-E-A-T fields
  jobTitle String? // WorksFor job title
  worksFor String? @db.ObjectId // Organization/Client reference
  bio      String?
  image    String? // Profile image
  url      String? // Author page URL

  // Social profiles for verification (sameAs)
  linkedIn String?
  twitter  String?
  facebook String?
  sameAs   String[] // Additional social profiles

  // E-E-A-T Signals
  credentials        String[] // Degrees, certifications
  qualifications     String[] // Professional qualifications
  expertiseAreas     String[] // Topics of specialization (knowsAbout)
  experienceYears    Int?
  verificationStatus Boolean  @default(false)

  // Education (optional structured data)
  education Json? // Array of education objects

  // SEO
  seoTitle       String?
  seoDescription String?

  // Optional user link
  userId String? @unique @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  articles Article[]

  @@map("authors")
}

// ============================================
// ARTICLE (CORE MODEL - FULL SEO OPTIMIZATION)
// ============================================

model Article {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Basic content
  title         String // Schema.org Article headline
  slug          String
  excerpt       String?
  content       String // Article body (markdown/HTML)
  contentFormat String  @default("markdown") // markdown, html, rich_text

  // Relationships
  clientId   String    @db.ObjectId
  client     Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  categoryId String?   @db.ObjectId
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  authorId   String    @db.ObjectId
  author     Author    @relation(fields: [authorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Status & workflow
  status      ArticleStatus @default(DRAFT)
  scheduledAt DateTime?
  featured    Boolean       @default(false)

  // Schema.org Article - Required fields
  datePublished    DateTime? // ISO 8601
  dateModified     DateTime  @updatedAt
  lastReviewed     DateTime? // Content freshness signal
  mainEntityOfPage String? // Canonical URL

  // Schema.org Article - Extended fields
  wordCount           Int? // Auto-calculated content depth
  readingTimeMinutes  Int? // Auto-calculated (~200-250 words/min)
  contentDepth        String? // short, medium, long
  inLanguage          String  @default("ar") // For hreflang
  isAccessibleForFree Boolean @default(true)
  license             String?
  creativeWorkStatus  String? // published, draft, etc.

  // Meta tags
  seoTitle       String?
  seoDescription String? // 155-160 chars optimal
  seoKeywords    String[]
  metaRobots     String? // index, noindex, follow, nofollow

  // Open Graph (Complete)
  ogTitle                String?
  ogDescription          String?
  ogImage                String?
  ogType                 String?   @default("article")
  ogUrl                  String?
  ogSiteName             String?
  ogLocale               String?
  ogUpdatedTime          DateTime?
  ogArticleAuthor        String?
  ogArticlePublishedTime DateTime?
  ogArticleModifiedTime  DateTime?
  ogArticleSection       String?
  ogArticleTag           String[]

  // Twitter Cards (Complete)
  twitterCard        String? // summary_large_image, summary
  twitterTitle       String?
  twitterDescription String?
  twitterImage       String?
  twitterSite        String?
  twitterCreator     String? // Author handle
  twitterLabel1      String?
  twitterData1       String?

  // Technical SEO
  canonicalUrl       String?
  alternateLanguages Json? // Array of {hreflang, url} objects
  robotsMeta         String? // Combined robots directive
  sitemapPriority    Float?  @default(0.5) // 0.0 to 1.0
  sitemapChangeFreq  String? @default("weekly") // always, hourly, daily, weekly, monthly, yearly, never

  // Breadcrumb support
  breadcrumbPath Json? // Array for BreadcrumbList schema

  // Featured media
  featuredImageId  String? @db.ObjectId
  featuredImage    Media?  @relation("ArticleFeaturedImage", fields: [featuredImageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  featuredImageAlt String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tags        ArticleTag[]
  versions    ArticleVersion[]
  analytics   Analytics[]
  relatedFrom RelatedArticle[] @relation("ArticleRelatedFrom")
  relatedTo   RelatedArticle[] @relation("ArticleRelatedTo")
  faqs        FAQ[]
  media       Media[]          @relation("ArticleMedia")

  @@unique([clientId, slug]) // Slug unique per client
  @@index([clientId, status, datePublished])
  @@index([status, datePublished])
  @@index([categoryId, status, datePublished])
  @@index([authorId, status, datePublished])
  @@index([dateModified])
  @@index([datePublished])
  @@map("articles")
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

// ============================================
// ARTICLE VERSION (VERSION CONTROL)
// ============================================

model ArticleVersion {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  // Snapshot of article data
  title          String
  content        String
  excerpt        String?
  seoTitle       String?
  seoDescription String?

  // Audit trail
  createdBy String?  @db.ObjectId // User ID
  createdAt DateTime @default(now())

  @@index([articleId, createdAt])
  @@map("article_versions")
}

// ============================================
// ARTICLE TAG (MANY-TO-MANY)
// ============================================

model ArticleTag {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  tagId     String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([articleId, tagId])
  @@index([articleId])
  @@index([tagId])
  @@map("article_tags")
}

// ============================================
// MEDIA (IMAGEOBJECT SCHEMA)
// ============================================

model Media {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // File info
  filename String
  url      String // CDN/Storage URL
  mimeType String
  fileSize Int? // Bytes

  // Schema.org ImageObject
  width           Int?
  height          Int?
  encodingFormat  String? // image/jpeg, image/png, etc.
  contentUrl      String?
  thumbnailUrl    String?
  copyrightHolder String?

  // SEO (Critical)
  altText     String? // Required for accessibility and SEO
  caption     String?
  credit      String?
  title       String?
  description String?
  keywords    String[]

  // Relationships
  articleId String?  @db.ObjectId
  article   Article? @relation("ArticleMedia", fields: [articleId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  featuredArticles Article[] @relation("ArticleFeaturedImage")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([articleId])
  @@map("media")
}

// ============================================
// ANALYTICS (CORE WEB VITALS + ENGAGEMENT)
// ============================================

model Analytics {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  clientId  String? @db.ObjectId

  // Core Web Vitals (2025 Standard)
  lcp  Float? // Largest Contentful Paint (target < 2.5s)
  cls  Float? // Cumulative Layout Shift (target < 0.1)
  inp  Float? // Interaction to Next Paint (target < 200ms) - replaced FID in 2024
  fid  Float? // First Input Delay (legacy, target < 100ms)
  ttfb Float? // Time to First Byte (target < 800ms)
  tbt  Float? // Total Blocking Time (target < 200ms)

  // Engagement metrics
  pageViews        Int    @default(0)
  uniqueVisitors   Int    @default(0)
  avgTimeOnPage    Float? // Seconds
  bounceRate       Float? // Percentage
  scrollDepth      Float? // Percentage
  clickThroughRate Float? // CTR

  // Traffic sources
  source         TrafficSource @default(ORGANIC)
  searchEngine   String? // Google, Bing, etc.
  referrerDomain String?

  timestamp DateTime @default(now())

  @@index([articleId, timestamp])
  @@index([clientId, timestamp])
  @@index([timestamp])
  @@map("analytics")
}

enum TrafficSource {
  ORGANIC
  DIRECT
  REFERRAL
  SOCIAL
  EMAIL
  PAID
}

// ============================================
// SUBSCRIBER (NEWSLETTER)
// ============================================

model Subscriber {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  email    String  @unique
  name     String?
  clientId String  @db.ObjectId
  client   Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // GDPR compliance
  subscribed     Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  consentGiven   Boolean   @default(false)
  consentDate    DateTime?

  // Preferences
  preferences Json? // Notification preferences

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@map("subscribers")
}

// ============================================
// FAQ (VOICE SEARCH OPTIMIZATION)
// ============================================

model FAQ {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  question String // Schema.org Question
  answer   String // Schema.org Answer
  position Int // Order in FAQ list

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([articleId, position])
  @@map("faqs")
}

// ============================================
// RELATED ARTICLE (INTERNAL LINKING)
// ============================================

model RelatedArticle {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  relatedId String  @db.ObjectId
  article   Article @relation("ArticleRelatedFrom", fields: [articleId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  related   Article @relation("ArticleRelatedTo", fields: [relatedId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  relationshipType String? @default("related") // related, similar, recommended
  weight           Float?  @default(1.0) // Relationship strength

  createdAt DateTime @default(now())

  @@unique([articleId, relatedId])
  @@index([articleId])
  @@index([relatedId])
  @@map("related_articles")
}
