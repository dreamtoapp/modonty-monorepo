// Main Prisma schema file for Modonty Blog Platform
// MongoDB provider for multi-client blog platform with 100% SEO optimization

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  CLIENT
  EDITOR
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum TrafficSource {
  ORGANIC
  DIRECT
  REFERRAL
  SOCIAL
  EMAIL
  PAID
}

enum SubscriptionTier {
  BASIC
  STANDARD
  PRO
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

enum PaymentStatus {
  PAID
  PENDING
  OVERDUE
}

// ============================================
// AUTHENTICATION MODELS
// ============================================

model User {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // NextAuth.js required fields
  name          String?
  email         String?   @unique
  emailVerified DateTime? // Email verification timestamp
  image         String? // NextAuth standard field (profile image URL)

  // Custom fields
  password String? // Hashed password (optional for OAuth users)
  role     UserRole @default(EDITOR)
  avatar   String? // Keep for compatibility, prefer using 'image'

  // Links to clients (for client users)
  clientAccess String[] @db.ObjectId // Array of client IDs this user can access

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // NextAuth.js relations
  accounts Account[]
  sessions Session[]

  @@index([role])
  @@map("users")
}

model Account {
  id                String @id @default(auto()) @map("_id") @db.ObjectId
  userId            String @db.ObjectId
  type              String // OAuth or email
  provider          String // google, facebook, credentials, etc.
  providerAccountId String // Provider's unique user ID

  // OAuth tokens (optional, for OAuth providers)
  refresh_token String?
  access_token  String?
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String?
  session_state String?

  // Relations
  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime

  // Relations
  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String // Email address or other identifier
  token      String   @unique
  expires    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// CLIENT/ORGANIZATION MODELS
// ============================================

model Client {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId // wiil use as unique for gtm integration
  name      String
  slug      String  @unique
  legalName String? // Schema.org Organization
  url       String? // Organization website

  // Branding
  logo         String?
  logoAlt      String? // Alt text for logo (accessibility + SEO)
  ogImage      String? // Default OG image for all articles
  ogImageAlt   String? // Alt text for OG image (accessibility + SEO)

  // Schema.org Organization - Social profiles
  sameAs String[] // LinkedIn, Twitter, Facebook URLs

  // Contact
  email String?
  phone String?

  // SEO
  seoTitle       String?
  seoDescription String?
  description    String? // Schema.org Organization description (separate from seoDescription)

  // Business Information
  businessBrief      String?  // Business description for content writers
  industryId         String?  @db.ObjectId // Industry/category
  industry           Industry? @relation(fields: [industryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  targetAudience     String?  // Target audience description
  contentPriorities  String[] // Key topics/priorities

  // Contact Point (Schema.org)
  contactType String? // customer service, technical support, sales, etc.

  // Address (for Local SEO)
  addressStreet  String?
  addressCity    String?
  addressCountry String?
  addressPostalCode String?

  // Twitter Cards
  twitterCard        String? // summary_large_image, summary
  twitterTitle       String?
  twitterDescription String?
  twitterImage       String?
  twitterImageAlt    String? // Alt text for Twitter image (accessibility + SEO)
  twitterSite        String? // @username

  // Canonical URL
  canonicalUrl String?

  // GTM Integration
  gtmId String? // Google Tag Manager ID

  // Subscription Management
  subscriptionTier      SubscriptionTier?
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?
  articlesPerMonth      Int? // Calculated from tier
  subscriptionStatus    SubscriptionStatus @default(PENDING)
  paymentStatus         PaymentStatus      @default(PENDING)

  // Metadata
  foundingDate DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relationships
  articles    Article[]
  subscribers Subscriber[]
  media       Media[] @relation("ClientMedia")

  @@index([industryId])
  @@map("clients")
}

// ============================================
// AUTHOR MODELS
// ============================================

model Author {
  id   String @id @default(auto()) @map("_id") @db.ObjectId
  name String // Schema.org Person
  slug String @unique

  // Schema.org Person - E-E-A-T fields
  jobTitle String? // WorksFor job title
  worksFor String? @db.ObjectId // Organization/Client reference
  bio      String?
  image    String? // Profile image
  imageAlt String? // Alt text for profile image (accessibility + SEO)
  url      String? // Author page URL

  // Social profiles for verification (sameAs)
  linkedIn String?
  twitter  String?
  facebook String?
  sameAs   String[] // Additional social profiles

  // E-E-A-T Signals
  credentials        String[] // Degrees, certifications
  qualifications     String[] // Professional qualifications
  expertiseAreas     String[] // Topics of specialization (knowsAbout)
  experienceYears    Int?
  verificationStatus Boolean  @default(false)

  // Education (optional structured data)
  education Json? // Array of education objects

  // SEO
  seoTitle       String?
  seoDescription String?

  // Optional user link
  userId String? @unique @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  articles Article[]

  @@map("authors")
}

// ============================================
// CONTENT MODELS
// ============================================

model Category {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String  @unique
  description String?
  parentId    String? @db.ObjectId // Hierarchical categories

  // SEO
  seoTitle       String?
  seoDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  articles Article[]
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("CategoryHierarchy")

  @@index([parentId])
  @@map("categories")
}

model Tag {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String   @unique
  description String?

  // SEO
  seoTitle       String?
  seoDescription String?
  ogImage        String?
  ogImageAlt     String?
  ogImageWidth   Int?
  ogImageHeight  Int?
  twitterCard    String?
  twitterTitle   String?
  twitterDescription String?
  twitterImage   String?
  twitterImageAlt String?
  canonicalUrl   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  articles ArticleTag[]

  @@map("tags")
}

model Industry {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  slug      String   @unique
  description String?

  // SEO
  seoTitle       String?
  seoDescription String?
  ogImage        String?
  ogImageAlt     String?
  ogImageWidth   Int?
  ogImageHeight  Int?
  twitterCard    String?
  twitterTitle   String?
  twitterDescription String?
  twitterImage   String?
  twitterImageAlt String?
  canonicalUrl   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  clients Client[]

  @@map("industries")
}

model Article {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Basic content
  title         String // Schema.org Article headline
  slug          String
  excerpt       String?
  content       String // Article body (markdown/HTML)
  contentFormat String  @default("markdown") // markdown, html, rich_text

  // Relationships
  clientId   String    @db.ObjectId
  client     Client    @relation(fields: [clientId], references: [id])
  categoryId String?   @db.ObjectId
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  authorId   String    @db.ObjectId
  author     Author    @relation(fields: [authorId], references: [id])

  // Status & workflow
  status      ArticleStatus @default(DRAFT)
  scheduledAt DateTime?
  featured    Boolean       @default(false)

  // Schema.org Article - Required fields
  datePublished    DateTime? // ISO 8601
  dateModified     DateTime  @updatedAt
  lastReviewed     DateTime? // Content freshness signal
  mainEntityOfPage String? // Canonical URL

  // Schema.org Article - Extended fields
  wordCount           Int? // Auto-calculated content depth
  readingTimeMinutes  Int? // Auto-calculated (~200-250 words/min)
  contentDepth        String? // short, medium, long
  inLanguage          String  @default("ar") // For hreflang
  isAccessibleForFree Boolean @default(true)
  license             String?
  creativeWorkStatus  String? // published, draft, etc.

  // Meta tags
  seoTitle       String?
  seoDescription String? // 155-160 chars optimal
  metaRobots     String? // index, noindex, follow, nofollow

  // Open Graph (Complete)
  ogTitle                String?
  ogDescription          String?
  ogImage                String?
  ogImageAlt             String? // Alt text for OG image (accessibility + SEO)
  ogImageWidth           Int?    // OG image width in pixels (recommended: 1200)
  ogImageHeight          Int?    // OG image height in pixels (recommended: 630)
  ogType                 String?   @default("article")
  ogUrl                  String?
  ogSiteName             String?
  ogLocale               String?
  ogUpdatedTime          DateTime?
  ogArticleAuthor        String?
  ogArticlePublishedTime DateTime?
  ogArticleModifiedTime  DateTime?
  ogArticleSection       String?
  ogArticleTag           String[]

  // Twitter Cards (Complete)
  twitterCard        String? // summary_large_image, summary
  twitterTitle       String?
  twitterDescription String?
  twitterImage       String?
  twitterImageAlt    String? // Alt text for Twitter image (accessibility + SEO)
  twitterSite        String?
  twitterCreator     String? // Author handle
  twitterLabel1      String?
  twitterData1       String?

  // Technical SEO
  canonicalUrl       String?
  alternateLanguages Json? // Array of {hreflang, url} objects
  robotsMeta         String? // Combined robots directive
  sitemapPriority    Float?  @default(0.5) // 0.0 to 1.0
  sitemapChangeFreq  String? @default("weekly") // always, hourly, daily, weekly, monthly, yearly, never

  // Breadcrumb support
  breadcrumbPath Json? // Array for BreadcrumbList schema

  // Featured media
  featuredImageId  String? @db.ObjectId
  featuredImage    Media?  @relation("ArticleFeaturedImage", fields: [featuredImageId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  featuredImageAlt String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tags        ArticleTag[]
  versions    ArticleVersion[]
  analytics   Analytics[]
  relatedFrom RelatedArticle[] @relation("ArticleRelatedFrom")
  relatedTo   RelatedArticle[] @relation("ArticleRelatedTo")
  faqs        FAQ[]

  @@unique([clientId, slug]) // Slug unique per client
  @@index([clientId, status, datePublished])
  @@index([status, datePublished])
  @@index([categoryId, status, datePublished])
  @@index([authorId, status, datePublished])
  @@index([dateModified])
  @@index([datePublished])
  @@map("articles")
}

model ArticleVersion {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Snapshot of article data
  title          String
  content        String
  excerpt        String?
  seoTitle       String?
  seoDescription String?

  // Audit trail
  createdBy String?  @db.ObjectId // User ID
  createdAt DateTime @default(now())

  @@index([articleId, createdAt])
  @@map("article_versions")
}

model ArticleTag {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  tagId     String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([articleId, tagId])
  @@index([articleId])
  @@index([tagId])
  @@map("article_tags")
}

// ============================================
// MEDIA MODELS
// ============================================

model Media {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // File info
  filename String
  url      String // CDN/Storage URL
  mimeType String
  fileSize Int? // Bytes

  // Schema.org ImageObject
  width           Int?
  height          Int?
  encodingFormat  String? // image/jpeg, image/png, etc.
  contentUrl      String?
  thumbnailUrl    String?
  copyrightHolder String?

  // SEO (Critical)
  altText     String? // Required for accessibility and SEO
  caption     String?
  credit      String?
  title       String?
  description String?
  license     String? // License type (CC0, CC-BY, CC-BY-SA, CC-BY-NC, Commercial, All Rights Reserved, Public Domain)
  creator     String? // Creator/Author name
  dateCreated DateTime? // Date when the image was created (from EXIF or manual)

  // Schema.org Enhancement
  geoLatitude     Float?  // Geographic latitude
  geoLongitude    Float?  // Geographic longitude
  geoLocationName String? // Human-readable location name
  contentLocation String? // Content location (where the image was taken/shows)
  exifData        Json?   // Full EXIF metadata stored as JSON

  // Cloudinary Integration
  cloudinaryPublicId  String? // Cloudinary public ID
  cloudinaryVersion   String? // Cloudinary version
  cloudinarySignature String? // Cloudinary signature

  // Client association (REQUIRED after migration)
  // Temporarily optional to allow querying existing media without clientId
  clientId String?  @db.ObjectId
  client   Client?  @relation("ClientMedia", fields: [clientId], references: [id], onDelete: Cascade)

  // Relationships
  featuredArticles Article[] @relation("ArticleFeaturedImage")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([clientId, createdAt])
  @@index([filename])
  @@map("media")
}

// ============================================
// ANALYTICS MODELS
// ============================================

model Analytics {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  clientId  String? @db.ObjectId

  // User/Session tracking (for unique visitor calculation)
  sessionId String? // Browser session ID (cookie-based)
  userId    String? @db.ObjectId // User ID if logged in

  // Core Web Vitals (2025 Standard) - per view
  lcp  Float? // Largest Contentful Paint (target < 2.5s)
  cls  Float? // Cumulative Layout Shift (target < 0.1)
  inp  Float? // Interaction to Next Paint (target < 200ms) - replaced FID in 2024
  fid  Float? // First Input Delay (legacy, target < 100ms)
  ttfb Float? // Time to First Byte (target < 800ms)
  tbt  Float? // Total Blocking Time (target < 200ms)

  // Engagement metrics - per view
  timeOnPage    Float? // Seconds spent on page for THIS view
  scrollDepth   Float? // Percentage scrolled (0-100) for THIS view
  bounced       Boolean @default(false) // Did user leave immediately? (bounce)
  clickThroughRate Float? // CTR for THIS view (if applicable)

  // Traffic sources - per view
  source         TrafficSource @default(ORGANIC)
  searchEngine   String? // Google, Bing, etc.
  referrerDomain String?
  userAgent      String? // Browser user agent
  ipAddress      String? // IP address (for geo-location if needed)

  timestamp DateTime @default(now())

  @@index([articleId, timestamp])
  @@index([clientId, timestamp])
  @@index([timestamp])
  @@index([sessionId])
  @@index([userId])
  @@map("analytics")
}

// ============================================
// NEWSLETTER MODELS
// ============================================

model Subscriber {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  email    String  @unique
  name     String?
  clientId String  @db.ObjectId
  client   Client  @relation(fields: [clientId], references: [id])

  // GDPR compliance
  subscribed     Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  consentGiven   Boolean   @default(false)
  consentDate    DateTime?

  // Preferences
  preferences Json? // Notification preferences

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@map("subscribers")
}

// ============================================
// RELATION MODELS
// ============================================

model FAQ {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  article   Article @relation(fields: [articleId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  question String // Schema.org Question
  answer   String // Schema.org Answer
  position Int // Order in FAQ list

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([articleId, position])
  @@map("faqs")
}

model RelatedArticle {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  articleId String  @db.ObjectId
  relatedId String  @db.ObjectId
  article   Article @relation("ArticleRelatedFrom", fields: [articleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  related   Article @relation("ArticleRelatedTo", fields: [relatedId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  relationshipType String? @default("related") // related, similar, recommended
  weight           Float?  @default(1.0) // Relationship strength

  createdAt DateTime @default(now())

  @@unique([articleId, relatedId])
  @@index([articleId])
  @@index([relatedId])
  @@map("related_articles")
}